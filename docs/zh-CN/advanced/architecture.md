# 架构指南

> 深入了解 KODE SDK 的心智模型、设计决策和运行时特性。

---

## 目录

1. [心智模型](#心智模型)
2. [核心架构](#核心架构)
3. [运行时特性](#运行时特性)
4. [决策框架](#决策框架)

---

## 心智模型

### KODE SDK 是什么

```
将 KODE SDK 类比为：

+------------------+     +------------------+     +------------------+
|       V8         |     |     SQLite       |     |    KODE SDK      |
|  JS 运行时       |     |  数据库引擎      |     |  Agent 运行时    |
+------------------+     +------------------+     +------------------+
        |                        |                        |
        v                        v                        v
+------------------+     +------------------+     +------------------+
|    Express.js    |     |     Prisma       |     |   你的应用       |
|  Web 框架        |     |       ORM        |     | (CLI/桌面/Web)   |
+------------------+     +------------------+     +------------------+
        |                        |                        |
        v                        v                        v
+------------------+     +------------------+     +------------------+
|      Vercel      |     |   PlanetScale    |     |   你的基础设施   |
|  云平台          |     |  云数据库        |     | (K8s/EC2/本地)   |
+------------------+     +------------------+     +------------------+
```

**KODE SDK 是引擎，不是平台。**

它提供：
- Agent 生命周期管理（创建、运行、暂停、恢复、分叉）
- 状态持久化（通过可插拔的 Store 接口）
- 工具执行与权限治理
- 事件流用于可观测性

它不提供：
- HTTP 路由或 API 框架
- 用户认证或授权
- 多租户或资源隔离
- 水平扩展或负载均衡

### 单一职责

```
                     KODE SDK 的职责
                           |
                           v
    +----------------------------------------------+
    |                                              |
    |   "保持这个 Agent 运行，从崩溃中恢复，      |
    |    让它可以分叉，并通过事件告诉我发生了什么" |
    |                                              |
    +----------------------------------------------+
                           |
                           v
                     你的应用的职责
                           |
                           v
    +----------------------------------------------+
    |                                              |
    |   "处理用户，路由请求，管理权限，           |
    |    扩展基础设施，与我的系统集成"            |
    |                                              |
    +----------------------------------------------+
```

---

## 核心架构

### 组件概览

```
+------------------------------------------------------------------+
|                         Agent 实例                                |
+------------------------------------------------------------------+
|                                                                   |
|  +------------------+  +------------------+  +------------------+ |
|  |  MessageQueue    |  | ContextManager   |  |   ToolRunner     | |
|  |  (用户输入)      |  | (Token 管理)     |  | (并行执行)       | |
|  +--------+---------+  +--------+---------+  +--------+---------+ |
|           |                     |                     |           |
|           +---------------------+---------------------+           |
|                                 |                                 |
|                    +------------v------------+                    |
|                    |    BreakpointManager    |                    |
|                    |   (8 阶段状态跟踪)      |                    |
|                    +------------+------------+                    |
|                                 |                                 |
|  +------------------+  +--------v---------+  +------------------+ |
|  | PermissionManager|  |     EventBus     |  |   TodoManager    | |
|  | (审批流程)       |  | (三通道事件)     |  | (任务跟踪)       | |
|  +------------------+  +------------------+  +------------------+ |
|                                                                   |
+----------------------------------+--------------------------------+
                                   |
                    +--------------+--------------+
                    |              |              |
           +--------v------+ +----v----+ +-------v-------+
           |     Store     | | Sandbox | | ModelProvider |
           | (持久化)      | | (执行)  | | (LLM 调用)    |
           +---------------+ +---------+ +---------------+
```

### 关键类和接口

| 组件 | 类 | 描述 |
|-----------|-------|-------------|
| Agent | `Agent` | 管理对话和工具执行的核心协调器 |
| Pool | `AgentPool` | 管理多个 Agent 实例的生命周期 |
| Room | `Room` | 多 Agent 消息传递和协作 |
| Store | `Store`, `JSONStore`, `SqliteStore`, `PostgresStore` | 持久化后端 |
| Sandbox | `LocalSandbox` | 隔离的执行环境 |
| Provider | `AnthropicProvider`, `OpenAIProvider`, `GeminiProvider` | LLM API 适配器 |
| Events | `EventBus` | 三通道事件分发 |
| Hooks | `HookManager` | 执行前/后拦截 |

### 数据流

```
用户消息
     |
     v
+----+----+     +-----------+     +------------+
| Message |---->|  Context  |---->|   Model    |
|  Queue  |     |  Manager  |     |  Provider  |
+---------+     +-----------+     +-----+------+
                                        |
                              +---------+---------+
                              |                   |
                         文本响应            工具调用
                              |                   |
                              v                   v
                    +---------+------+    +------+-------+
                    |    EventBus    |    |  ToolRunner  |
                    | (text_chunk)   |    | (并行执行)   |
                    +----------------+    +------+-------+
                                                 |
                              +------------------+------------------+
                              |                  |                  |
                         权限检查            执行              结果处理
                              |           (Sandbox)                |
                              v                  v                  v
                    +--------------------+  +---------+  +------------------+
                    | PermissionManager  |  | Sandbox |  |    EventBus      |
                    | (Control 通道)     |  | (exec)  |  | (tool:end)       |
                    +--------------------+  +---------+  +------------------+
```

### 断点状态机

`BreakpointManager` 跟踪 8 个状态用于崩溃恢复：

```
Agent 执行流程：

  READY -> PRE_MODEL -> STREAMING_MODEL -> TOOL_PENDING -> AWAITING_APPROVAL
    |         |              |                 |                |
    +-------- WAL 保护状态 --+-- 等待审批 -----+
                                                                |
                        +---------------------------------------+
                        |
                        v
            PRE_TOOL -> TOOL_EXECUTING -> POST_TOOL -> READY
                |             |              |
                +---- 工具执行 -------------+

崩溃恢复：从最后一个安全断点恢复，自动封印未完成的工具调用
```

**BreakpointState 值**（来自 `src/core/types.ts:69`）：
- `READY` - Agent 空闲，等待输入
- `PRE_MODEL` - 即将调用 LLM
- `STREAMING_MODEL` - 接收 LLM 响应
- `TOOL_PENDING` - 工具调用已解析，等待执行
- `AWAITING_APPROVAL` - 等待权限决策
- `PRE_TOOL` - 即将执行工具
- `TOOL_EXECUTING` - 工具运行中
- `POST_TOOL` - 工具完成，处理结果

### 三通道事件系统

```
+-------------+     +-------------+     +-------------+
|  Progress   |     |   Control   |     |   Monitor   |
+-------------+     +-------------+     +-------------+
| text_chunk  |     | permission  |     | state_changed|
| tool:start  |     | _required   |     | token_usage |
| tool:end    |     | permission  |     | tool_executed|
| done        |     | _decided    |     | error       |
+-------------+     +-------------+     +-------------+
      |                   |                   |
      v                   v                   v
   你的 UI         审批服务            可观测性
```

**使用模式：**

```typescript
// Progress: 实时流式输出用于 UI
for await (const envelope of agent.subscribe(['progress'])) {
  if (envelope.event.type === 'text_chunk') {
    process.stdout.write(envelope.event.delta);
  }
}

// Control: 审批工作流
agent.on('permission_required', async (event) => {
  await event.respond('allow');
});

// Monitor: 可观测性
agent.on('token_usage', (event) => {
  console.log('Tokens:', event.totalTokens);
});
```

---

## 运行时特性

### 内存模型

```
Agent 内存占用（典型值）：

+---------------------------+
|     Agent 实例            |
+---------------------------+
| messages[]: 10KB - 2MB    |  <-- 随对话增长
| toolRecords: 1KB - 100KB  |  <-- 随工具使用增长
| eventTimeline: 5KB - 500KB|  <-- 缓存最近事件
| mediaCache: 0 - 10MB      |  <-- 如果涉及图片/文件
| baseObjects: ~50KB        |  <-- 固定开销
+---------------------------+

典型范围：每个 Agent 100KB - 5MB
AgentPool (50 个 Agent)：5MB - 250MB
```

### I/O 模式

```
每个 Agent 步骤：

+-------------------+     +-------------------+     +-------------------+
| persistMessages() |     | persistToolRecs() |     | emitEvents()      |
| ~20-50ms (SSD)    |     | ~5-10ms           |     | ~1-5ms (缓冲)     |
+-------------------+     +-------------------+     +-------------------+

每步总计：30-70ms I/O 开销

大规模（100 个并发 Agent）：
- JSONStore 存在顺序瓶颈
- 需要 SqliteStore/PostgresStore 支持并行写入
```

---

## 决策框架

### 何时使用 KODE SDK

```
+------------------+
|    决策树        |
+------------------+
         |
         v
+------------------+
| 单用户/          |----是---> 直接使用（CLI/桌面）
| 本地机器？       |
+--------+---------+
         | 否
         v
+----------------------+
| < 100 并发用户？     |----是---> 单服务器（AgentPool）
+--------+-------------+
         | 否
         v
+----------------------+
| 可以运行长进程？     |----是---> Worker 微服务模式
+--------+-------------+
         | 否
         v
+----------------------+
| 只能 Serverless？    |----是---> 混合模式（API + Workers）
+--------+-------------+
```

### 平台兼容性矩阵

| 平台 | 兼容性 | 备注 |
|----------|------------|-------|
| Node.js | 100% | 主要目标 |
| Bun | 95% | 需要少量调整 |
| Deno | 80% | 需要权限标志 |
| Electron | 90% | 在主进程中使用 |
| VSCode Extension | 85% | 需要 workspace.fs 集成 |
| Vercel Functions | 20% | 仅 API 层，不适合 Agent |
| Cloudflare Workers | 5% | 不兼容 |
| 浏览器 | 10% | 无 fs/process，非常受限 |

### Store 选择指南

| Store | 使用场景 | 吞吐量 | 扩展性 |
|-------|----------|------------|---------|
| `JSONStore` | 开发、CLI | 低 | 单节点 |
| `SqliteStore` | 桌面应用、小型服务器 | 中 | 单节点 |
| `PostgresStore` | 生产环境、多节点 | 高 | 多节点 |

**Store 接口层级**（来自 `src/infra/store/types.ts`）：

```
Store（基础）
  └── QueryableStore（添加查询方法）
        └── ExtendedStore（添加健康检查、指标、分布式锁）
```

---

## 总结

### 核心原则

1. **KODE SDK 是运行时内核** - 它管理 Agent 生命周期，而不是应用基础设施

2. **Agent 是有状态的** - 它们需要持久化存储和长时间运行的进程

3. **通过架构扩展** - 使用 Worker 模式进行大规模部署

4. **Store 可插拔** - 为你的基础设施实现自定义 Store

### 快速参考

| 场景 | 模式 | Store | 规模 |
|----------|---------|-------|-------|
| CLI 工具 | 单进程 | JSONStore | 1 用户 |
| 桌面应用 | 单进程 | SqliteStore | 1 用户 |
| 内部工具 | 单服务器 | SqliteStore/PostgresStore | ~100 用户 |
| SaaS 产品 | Worker 微服务 | PostgresStore | 10K+ 用户 |
| Serverless 应用 | 混合 | 外部 DB | 视情况 |

---

*另请参阅：[生产部署](./production.md) | [数据库指南](../guides/database.md)*
